from lasso_workbench.altframe.binning import compute_bins, window_from_bins


def test_compute_bins_basic():
    result = compute_bins(1000, 2000, 1150, 1600, 20)
    assert result == (3, 12)


def test_compute_bins_no_overlap():
    result = compute_bins(1000, 2000, 500, 800, 20)
    assert result is None


def test_compute_bins_clamps_end():
    result = compute_bins(0, 1000, 900, 1000, 20)
    assert result is not None
    bin_start, bin_end = result
    assert bin_end == 19
    assert bin_start <= bin_end


def test_compute_bins_one_nt_overlap():
    result = compute_bins(0, 1000, 999, 1000, 20)
    assert result == (19, 19)


def test_window_from_bins_roundtrip_includes_original():
    gene_start = 0
    gene_end = 1000
    bin_start = 4
    bin_end = 6
    bins = 20
    window_start, window_end = window_from_bins(gene_start, gene_end, bin_start, bin_end, bins)
    roundtrip = compute_bins(gene_start, gene_end, window_start, window_end, bins)
    assert roundtrip is not None
    new_bin_start, new_bin_end = roundtrip
    assert new_bin_start == bin_start
    assert new_bin_end >= bin_end
import sys

from Bio import SeqIO
from Bio.Seq import Seq
from Bio.SeqFeature import FeatureLocation, SeqFeature
from Bio.SeqRecord import SeqRecord

from lasso_workbench.altframe import cli


def test_cli_smoke(tmp_path, monkeypatch):
    seq = Seq("ATG" + "GCT" * 15 + "TAA")
    record = SeqRecord(seq, id="TEST", name="TEST", description="")
    record.annotations["molecule_type"] = "DNA"
    feature = SeqFeature(
        FeatureLocation(0, len(seq), strand=1),
        type="CDS",
        qualifiers={"gene": ["testGene"]},
    )
    record.features = [feature]

    gbk_path = tmp_path / "test.gbk"
    SeqIO.write(record, gbk_path, "genbank")

    hits_path = tmp_path / "hits.tsv"
    hits_path.write_text(
        "\t".join(
            [
                "gene_name",
                "match_type",
                "orf_strand",
                "orf_frame",
                "gene_start",
                "gene_end",
                "orf_start",
                "orf_end",
                "gbk_file",
                "record_id",
            ]
        )
        + "\n"
        + "\t".join(
            [
                "testGene",
                "out_of_frame",
                "+",
                "0",
                "0",
                str(len(seq)),
                "0",
                str(len(seq)),
                gbk_path.name,
                "TEST",
            ]
        )
        + "\n"
    )

    out_dir = tmp_path / "out"
    argv = [
        "prog",
        "--gbk-dir",
        str(tmp_path),
        "--hits-file",
        str(hits_path),
        "--output-dir",
        str(out_dir),
        "--min-genomes",
        "1",
        "--max-candidates",
        "5",
        "--null-iterations",
        "3",
        "--geom-bins",
        "10",
    ]
    monkeypatch.setattr(sys, "argv", argv)

    result = cli.main()
    assert result == 0
    out_path = out_dir / "altframe_constraint_conservation.tsv"
    assert out_path.exists()
    contents = out_path.read_text().strip().splitlines()
    assert len(contents) >= 2
    header = contents[0].split("\t")
    assert "obs_survival" in header
    assert "null_survival_mean" in header
import random

from lasso_workbench.altframe.codon_shuffle import shuffle_synonymous_codons, synonym_maps


def test_shuffle_preserves_start_and_multiset():
    rng = random.Random(42)
    codons = ["ATG", "GCT", "GCC", "GCA", "GCG"]
    aas = ["M", "A", "A", "A", "A"]
    shuffled = shuffle_synonymous_codons(codons, aas, rng)

    assert shuffled[0] == "ATG"
    assert sorted(shuffled[1:]) == sorted(codons[1:])

    _, codon_to_aa = synonym_maps()
    assert [codon_to_aa.get(c, "X") for c in shuffled] == aas


def test_shuffle_does_not_move_unknown_aa():
    rng = random.Random(7)
    codons = ["ATG", "GCT", "NNN", "GCC"]
    aas = ["M", "A", "X", "A"]
    shuffled = shuffle_synonymous_codons(codons, aas, rng)

    assert shuffled[0] == "ATG"
    assert shuffled[2] == "NNN"


def test_shuffle_deterministic_with_seed():
    codons = ["ATG", "GCT", "GCC", "GCA", "GCG"]
    aas = ["M", "A", "A", "A", "A"]
    rng1 = random.Random(13)
    rng2 = random.Random(13)
    assert shuffle_synonymous_codons(codons, aas, rng1) == shuffle_synonymous_codons(codons, aas, rng2)


def test_shuffle_preserves_first_position_even_with_synonyms():
    rng = random.Random(5)
    codons = ["GTG", "GTT", "GTC", "GTA"]
    aas = ["V", "V", "V", "V"]
    shuffled = shuffle_synonymous_codons(codons, aas, rng)
    assert shuffled[0] == "GTG"
import math

from lasso_workbench.altframe.conservation import (
    mean_pairwise_identity,
    p_value,
    summarize_null,
    translate_window,
)


def test_mean_pairwise_identity_identical():
    assert mean_pairwise_identity(["MAG", "MAG", "MAG"]) == 1.0


def test_mean_pairwise_identity_different():
    result = mean_pairwise_identity(["MAG", "MAR"])
    assert abs(result - (2 / 3)) < 0.01


def test_mean_pairwise_identity_empty():
    assert math.isnan(mean_pairwise_identity([]))


def test_mean_pairwise_identity_single_sequence():
    assert math.isnan(mean_pairwise_identity(["MAG"]))


def test_mean_pairwise_identity_length_mismatch():
    assert mean_pairwise_identity(["AAAA", "AAAAZZ"]) == 1.0


def test_translate_window_frames():
    base = "ATGAAATTTCCC"
    assert translate_window(base, "+", 0, "zero").startswith("MKF")
    assert translate_window("A" + base, "+", 1, "zero").startswith("MKF")
    assert translate_window("AA" + base, "+", 2, "zero").startswith("MKF")


def test_translate_window_reverse_strand():
    seq = "ATGAAATTTCCC"
    pep = translate_window(seq, "-", -1, "zero")
    assert pep == "GKFH"


def test_translate_window_reverse_strand_frame_offset():
    seq = "ATGAAATTTCCC"
    pep = translate_window(seq, "-", -2, "zero")
    assert pep == "GNF"


def test_p_value_basic():
    assert p_value(1, 3) == 0.5


def test_summarize_null_basic():
    mean, std = summarize_null([0.2, 0.4, 0.6])
    assert abs(mean - 0.4) < 1e-6
    assert std > 0
from Bio import SeqIO
from Bio.Seq import Seq
from Bio.SeqFeature import FeatureLocation, SeqFeature
from Bio.SeqRecord import SeqRecord

from lasso_workbench.altframe.gene_extraction import extract_gene_instances


def test_extract_gene_instances_from_gbk(tmp_path):
    seq = Seq("ATG" + "GCT" * 10 + "TAA")
    record = SeqRecord(seq, id="TEST", name="TEST", description="")
    record.annotations["molecule_type"] = "DNA"
    feature = SeqFeature(
        FeatureLocation(0, len(seq), strand=1),
        type="CDS",
        qualifiers={"gene": ["testGene"]},
    )
    record.features = [feature]

    gbk_path = tmp_path / "test.gbk"
    SeqIO.write(record, gbk_path, "genbank")

    instances = extract_gene_instances(tmp_path, {"testGene"}, "gene")
    assert "testGene" in instances
    assert len(instances["testGene"]) == 1
    inst = instances["testGene"][0]
    assert inst.gene_start == 0
    assert inst.gene_end == len(seq)
    assert inst.gene_strand == "+"
    assert inst.gene_genomic == str(seq)


def test_extract_gene_instances_minus_strand(tmp_path):
    seq = Seq("ATGAAACCCGGG")
    record = SeqRecord(seq, id="TEST_MINUS", name="TEST_MINUS", description="")
    record.annotations["molecule_type"] = "DNA"
    feature = SeqFeature(
        FeatureLocation(0, len(seq), strand=-1),
        type="CDS",
        qualifiers={"gene": ["minusGene"]},
    )
    record.features = [feature]

    gbk_path = tmp_path / "minus.gbk"
    SeqIO.write(record, gbk_path, "genbank")

    instances = extract_gene_instances(tmp_path, {"minusGene"}, "gene")
    assert "minusGene" in instances
    assert len(instances["minusGene"]) == 1
    inst = instances["minusGene"][0]
    assert inst.gene_strand == "-"
    assert inst.gene_genomic == str(seq)
    assert inst.codons[:4] == ["CCC", "GGG", "TTT", "CAT"]
